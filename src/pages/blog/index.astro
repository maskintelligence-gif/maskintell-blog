---
import BaseLayout from "../../layouts/BaseLayout.astro";
import posts from "../../../content/posts";
import { getCollection } from "astro:content";

/* =========================
   FILTER & SORT POSTS
========================= */
const posts = await getCollection("posts");
const publishedPosts = posts
  .filter((post) => post.status === "published")
  .sort((a, b) => new Date(b.date) - new Date(a.date));
---

<BaseLayout title="Blog">

<input id="search" placeholder="Search posts..." />

  <div id="posts">
    {posts.map(post => (
      <article
        class="post"
        data-title={post.data.title.toLowerCase()}
        data-tags={post.data.tags?.join(",").toLowerCase()}
      >
        <BlogCard post={post} />
      </article>
    ))}
  </div>

<script>
    const input = document.getElementById("search");
    const posts = document.querySelectorAll(".post");

    input.addEventListener("input", e => {
      const q = e.target.value.toLowerCase();
      posts.forEach(p => {
        const match =
          p.dataset.title.includes(q) ||
          p.dataset.tags?.includes(q);
        p.style.display = match ? "block" : "none";
      });
    });
  </script>

  <section class="section container">
    <header class="page-header">
      <h1>Blog</h1>
      <p class="page-description">
        Insights, tutorials, and engineering notes from MASK Intelligence.
      </p>
    </header>

    <div class="grid">
      {publishedPosts.map((post) => (
        <article class="card">
          {post.thumbnail && (
            <img
              src={post.thumbnail}
              alt={post.image_alt || post.title}
              loading="lazy"
            />
          )}

          <h2>{post.title}</h2>

          {post.excerpt && (
            <p class="excerpt">{post.excerpt}</p>
          )}

          <div class="meta">
            <span>{new Date(post.date).toLocaleDateString()}</span>
            {post.reading_time > 0 && (
              <span>· {post.reading_time} min read</span>
            )}
          </div>

          <a href={`/blog/${post.slug}`} class="link">
            Read Article →
          </a>
        </article>
      ))}
    </div>
  </section>

</BaseLayout>
